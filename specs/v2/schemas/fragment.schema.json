{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://opskarta.dev/schemas/v2/fragment.schema.json",
  "title": "opskarta v2 fragment file",
  "description": "Schema for individual YAML file (fragment) in opskarta v2 Plan Set",
  "type": "object",
  "properties": {
    "version": {
      "type": "integer",
      "const": 2,
      "description": "Plan format version, must be 2 for v2"
    },
    "meta": {
      "$ref": "#/$defs/meta"
    },
    "statuses": {
      "type": "object",
      "description": "Dictionary of status_id -> status definition",
      "additionalProperties": {
        "$ref": "#/$defs/status"
      }
    },
    "nodes": {
      "type": "object",
      "description": "Dictionary of node_id -> node definition",
      "additionalProperties": {
        "$ref": "#/$defs/node"
      }
    },
    "schedule": {
      "$ref": "#/$defs/schedule"
    },
    "views": {
      "type": "object",
      "description": "Dictionary of view_id -> view definition",
      "additionalProperties": {
        "$ref": "#/$defs/view"
      }
    },
    "x": {
      "type": "object",
      "description": "Extension data (arbitrary key-value pairs)"
    }
  },
  "additionalProperties": false,
  "$defs": {
    "meta": {
      "type": "object",
      "description": "Plan metadata",
      "properties": {
        "id": {
          "type": "string",
          "minLength": 1,
          "description": "Unique identifier for the plan"
        },
        "title": {
          "type": "string",
          "minLength": 1,
          "description": "Human-readable title of the plan"
        },
        "effort_unit": {
          "type": "string",
          "description": "Display unit for effort values (e.g., 'sp', 'points', 'дни'). Only affects UI display, not calculations"
        }
      },
      "additionalProperties": false
    },
    "status": {
      "type": "object",
      "description": "Status definition for nodes",
      "required": ["label"],
      "properties": {
        "label": {
          "type": "string",
          "minLength": 1,
          "description": "Human-readable label for the status"
        },
        "color": {
          "type": "string",
          "pattern": "^#[0-9a-fA-F]{6}$",
          "description": "Hex color code for display (format: #RRGGBB)"
        }
      },
      "additionalProperties": false
    },
    "node": {
      "type": "object",
      "description": "Work item in the plan structure (v2). NO start, finish, duration, excludes - these are in schedule",
      "required": ["title"],
      "properties": {
        "title": {
          "type": "string",
          "minLength": 1,
          "description": "Human-readable title of the node"
        },
        "kind": {
          "type": "string",
          "description": "Type/category (e.g., 'summary', 'phase', 'epic', 'task')"
        },
        "status": {
          "type": "string",
          "description": "Reference to a status_id defined in statuses"
        },
        "parent": {
          "type": "string",
          "description": "Reference to parent node_id for hierarchy"
        },
        "after": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "List of node_ids this node depends on"
        },
        "milestone": {
          "type": "boolean",
          "description": "Whether this node is a milestone"
        },
        "issue": {
          "type": "string",
          "description": "Issue tracker reference"
        },
        "notes": {
          "type": "string",
          "description": "Notes/description"
        },
        "effort": {
          "type": "number",
          "minimum": 0,
          "description": "Effort estimate in abstract units (number >= 0)"
        },
        "x": {
          "type": "object",
          "description": "Extension data (arbitrary key-value pairs)"
        }
      },
      "additionalProperties": false
    },
    "calendar": {
      "type": "object",
      "description": "Calendar definition for scheduling",
      "properties": {
        "excludes": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "List of exclusions: 'weekends' or 'YYYY-MM-DD' dates"
        }
      },
      "additionalProperties": false
    },
    "schedule_node": {
      "type": "object",
      "description": "Scheduling information for a node. Note: dependencies (after) are defined in Node, not here",
      "properties": {
        "start": {
          "type": "string",
          "pattern": "^\\d{4}-\\d{2}-\\d{2}$",
          "description": "Start date in YYYY-MM-DD format"
        },
        "finish": {
          "type": "string",
          "pattern": "^\\d{4}-\\d{2}-\\d{2}$",
          "description": "Finish date in YYYY-MM-DD format"
        },
        "duration": {
          "type": "string",
          "pattern": "^[1-9][0-9]*[dw]$",
          "description": "Duration in days (d) or weeks (w), e.g. 5d, 2w"
        },
        "calendar": {
          "type": "string",
          "description": "Reference to calendar_id in schedule.calendars"
        }
      },
      "additionalProperties": false
    },
    "schedule": {
      "type": "object",
      "description": "Calendar scheduling layer (optional)",
      "properties": {
        "calendars": {
          "type": "object",
          "description": "Dictionary of calendar_id -> calendar definition",
          "additionalProperties": {
            "$ref": "#/$defs/calendar"
          }
        },
        "default_calendar": {
          "type": "string",
          "description": "Reference to default calendar_id"
        },
        "nodes": {
          "type": "object",
          "description": "Dictionary of node_id -> schedule node definition",
          "additionalProperties": {
            "$ref": "#/$defs/schedule_node"
          }
        }
      },
      "additionalProperties": false
    },
    "view_filter": {
      "type": "object",
      "description": "Structural filter for node selection in views",
      "properties": {
        "kind": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Filter by node.kind (node must have kind in this list)"
        },
        "status": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Filter by node.status (node must have status in this list)"
        },
        "has_schedule": {
          "type": "boolean",
          "description": "Filter by scheduling status: true = only scheduled nodes, false = only unscheduled"
        },
        "parent": {
          "type": "string",
          "description": "Filter to descendants of specified node_id"
        }
      },
      "additionalProperties": false
    },
    "view": {
      "type": "object",
      "description": "View configuration for visualization. NO excludes field (moved to schedule.calendars)",
      "properties": {
        "title": {
          "type": "string",
          "description": "Display title for the view"
        },
        "where": {
          "$ref": "#/$defs/view_filter"
        },
        "order_by": {
          "type": "string",
          "description": "Field name for sorting nodes"
        },
        "group_by": {
          "type": "string",
          "description": "Field name for grouping nodes"
        },
        "lanes": {
          "type": "object",
          "description": "Lane configuration for Gantt views",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "title": {
                "type": "string"
              },
              "nodes": {
                "type": "array",
                "items": {
                  "type": "string"
                }
              }
            },
            "additionalProperties": false
          }
        },
        "date_format": {
          "type": "string",
          "description": "Date format string for display"
        },
        "axis_format": {
          "type": "string",
          "description": "Axis format string for Gantt"
        },
        "tick_interval": {
          "type": "string",
          "description": "Tick interval for Gantt axis"
        }
      },
      "additionalProperties": false
    }
  }
}
