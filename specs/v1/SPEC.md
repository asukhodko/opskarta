<!-- Этот файл сгенерирован автоматически. Не редактируйте вручную! -->
<!-- Для изменений редактируйте файлы в spec/ и запустите: python tools/build_spec.py -->

## Оглавление

- [Спецификация opskarta v1 (черновик)](#спецификация-opskarta-v1-черновик)
- [Файл плана (`*.plan.yaml`)](#файл-плана-planyaml)
- [Узлы (`nodes`)](#узлы-nodes)
- [Файл представлений (`*.views.yaml`)](#файл-представлений-viewsyaml)
- [Статусы (`statuses`)](#статусы-statuses)
- [Планирование (`start`, `duration`, `after`)](#планирование-start-duration-after)
- [Правила валидации](#правила-валидации)
- [Расширяемость](#расширяемость)

# Спецификация opskarta v1 (черновик)

Эта спецификация описывает *минимальный* совместимый набор полей формата opskarta.

- Формат серилизации: **YAML** (рекомендовано) или JSON.
- Версионирование: поле `version` в корне документа.
- Идентификаторы узлов: строковые ключи в мапе `nodes:`.

> Статус: **Draft**. Спека намеренно стартует маленькой и расширяемой.

---

# Файл плана (`*.plan.yaml`)

## Корневые поля

- `version` *(int)* — версия схемы.
- `meta` *(object)* — метаданные плана.
  - `id` *(string)* — ID проекта/программы. Используется для связки с файлами представлений.
  - `title` *(string)* — человекочитаемое имя.
- `statuses` *(object)* — словарь статусов.
- `nodes` *(object)* — словарь узлов работ: `{ <node_id>: <node> }`.

## Пример

```yaml
version: 1
meta:
  id: demo
  title: "Demo"

statuses:
  not_started: { label: "Не начато", color: "#9ca3af" }
  in_progress: { label: "В работе",  color: "#0ea5e9" }

nodes:
  root:
    title: "Root"
    kind: summary
    status: in_progress
```

---

# Узлы (`nodes`)

Узел — это единица работ/смысла в твоей карте.

## Обязательные поля узла

- `title` *(string)* — имя работы.

## Рекомендуемые поля

- `kind` *(string)* — тип узла. Рекомендованные значения:
  - `summary` — верхнеуровневый контейнер
  - `phase` — этап/фаза
  - `epic` — крупная сущность в системе деталей
  - `user_story` — история/ценность
  - `task` — конкретная задача

- `status` *(string)* — ключ статуса из `statuses`.

- `parent` *(string)* — ID родительского узла (иерархия декомпозиции).

- `after` *(list[string])* — зависимости "после чего" (граф).  
  Семантика: узел может стартовать после завершения всех `after`.

- Планирование:
  - `start` *(YYYY-MM-DD)* — плановая дата старта
  - `duration` *(string)* — длительность, например `5d`

- `issue` *(string)* — ссылка/ключ в системе деталей (например, `JIRA-123`).

- `notes` *(string|multiline)* — заметки/контекст, который не хочется терять.

## Примечания

- opskarta не диктует workflow. `status` — это метка для твоей карты.
- Узел может существовать без `issue` (черновик, гипотеза, заготовка).

---

# Файл представлений (`*.views.yaml`)

Файл представлений описывает, *как* смотреть на план.

## Корневые поля

- `version` *(int)*
- `project` *(string)* — должен совпадать с `meta.id` плана
- `gantt_views` *(object)* — набор Gantt‑представлений (опционально)

## Gantt view

- `title` *(string)* — заголовок
- `excludes` *(list[string])* — исключения календаря (пока поддерживается только `weekends`)
- `lanes` *(object)* — полосы/лейны
  - `<lane_id>.title` *(string)*
  - `<lane_id>.nodes` *(list[string])* — список node_id, которые показываем в этом лейне

## Пример

```yaml
version: 1
project: demo

gantt_views:
  overview:
    title: "Overview"
    excludes: ["weekends"]
    lanes:
      main:
        title: "Main"
        nodes: [root, task1]
```

---

# Статусы (`statuses`)

`statuses` — словарь произвольных статусов, которые понимает твой набор инструментов.

Рекомендованные ключи (не обязательны, но помогают совместимости):

- `not_started`
- `in_progress`
- `done`
- `blocked`

Каждый статус — объект:

- `label` *(string)* — человекочитаемое имя
- `color` *(string)* — цвет (hex), полезен для визуализаций

Пример:

```yaml
statuses:
  done: { label: "Готово", color: "#22c55e" }
```

---

# Планирование (`start`, `duration`, `after`)

Поля планирования позволяют задать временные характеристики узлов и зависимости между ними.

## Поля планирования

- `start` *(string, YYYY-MM-DD)* — плановая дата начала работы.
  Формат: ISO 8601 дата, например `2024-03-15`.

- `duration` *(string)* — длительность работы.
  Формат: число с суффиксом единицы времени:
  - `d` — дни (например, `5d` = 5 дней)
  - `w` — недели (например, `2w` = 2 недели)

- `after` *(list[string])* — список ID узлов-зависимостей.
  Семантика: узел может стартовать только после завершения **всех** узлов из списка `after`.

## Примеры

### Узел с фиксированной датой старта

```yaml
nodes:
  kickoff:
    title: "Kickoff"
    start: "2024-03-01"
    duration: "1d"
```

### Узел с зависимостью

```yaml
nodes:
  design:
    title: "Дизайн"
    start: "2024-03-01"
    duration: "5d"

  implementation:
    title: "Реализация"
    after: [design]
    duration: "10d"
```

В этом примере `implementation` может начаться только после завершения `design`.

### Узел с несколькими зависимостями

```yaml
nodes:
  backend:
    title: "Backend API"
    duration: "5d"

  frontend:
    title: "Frontend UI"
    duration: "3d"

  integration:
    title: "Интеграция"
    after: [backend, frontend]
    duration: "2d"
```

Узел `integration` ждёт завершения **обоих** узлов `backend` и `frontend`.

## Взаимодействие с представлениями

Поля планирования используются рендерерами для построения временных диаграмм:

- **Gantt-диаграммы**: `start` и `duration` определяют позицию и длину полосы узла на временной шкале.
- **Зависимости**: `after` может отображаться как стрелки между узлами.
- **Исключения календаря**: параметр `excludes` в `gantt_views` (например, `weekends`) влияет на расчёт дат при наличии `duration`.

## Примечания

- Если `start` не указан, но есть `after`, дата старта вычисляется как максимальная дата окончания зависимостей.
- Если ни `start`, ни `after` не указаны, узел считается непланируемым (не отображается на временной шкале).
- `duration` без `start` или `after` не имеет смысла для временной шкалы, но может использоваться для оценки трудозатрат.

---

# Правила валидации

Этот раздел описывает правила валидации файлов плана и представлений.

## Валидация файла плана (`*.plan.yaml`)

### Обязательные поля

- `version` *(int)* — должен присутствовать в корне документа.
- `nodes` *(object)* — должен присутствовать (может быть пустым).
- Для каждого узла: `title` *(string)* — обязательное поле.

### Ссылочная целостность

#### Родительские ссылки (`parent`)

- Если узел содержит поле `parent`, значение ДОЛЖНО быть ключом существующего узла в `nodes`.
- Циклические ссылки через `parent` запрещены.

```yaml
# Корректно
nodes:
  root:
    title: "Root"
  child:
    title: "Child"
    parent: root  # root существует

# Ошибка: несуществующий parent
nodes:
  child:
    title: "Child"
    parent: nonexistent  # ошибка!
```

#### Зависимости (`after`)

- Каждый элемент списка `after` ДОЛЖЕН быть ключом существующего узла в `nodes`.
- Циклические зависимости через `after` запрещены.

```yaml
# Корректно
nodes:
  task1:
    title: "Task 1"
  task2:
    title: "Task 2"
    after: [task1]  # task1 существует

# Ошибка: несуществующая зависимость
nodes:
  task2:
    title: "Task 2"
    after: [missing_task]  # ошибка!
```

#### Статусы (`status`)

- Если узел содержит поле `status`, значение ДОЛЖНО быть ключом из словаря `statuses`.

```yaml
statuses:
  done: { label: "Готово" }

nodes:
  task:
    title: "Task"
    status: done  # корректно, done есть в statuses

# Ошибка: несуществующий статус
nodes:
  task:
    title: "Task"
    status: completed  # ошибка, если completed нет в statuses!
```

### Формат полей планирования

- `start` — если указан, ДОЛЖЕН соответствовать формату `YYYY-MM-DD`.
- `duration` — если указан, ДОЛЖЕН соответствовать формату `<число><единица>`, где единица: `d` (дни) или `w` (недели).

## Валидация файла представлений (`*.views.yaml`)

### Обязательные поля

- `version` *(int)* — должен присутствовать.
- `project` *(string)* — должен присутствовать.

### Связь с файлом плана

- Поле `project` ДОЛЖНО совпадать с `meta.id` соответствующего файла плана.

```yaml
# plan.yaml
meta:
  id: my-project

# views.yaml
project: my-project  # должно совпадать с meta.id
```

### Ссылки на узлы в представлениях

- Каждый `node_id` в `lanes[].nodes` ДОЛЖЕН существовать в файле плана.

```yaml
# Если в плане есть nodes: {task1, task2}
gantt_views:
  overview:
    lanes:
      main:
        nodes: [task1, task2]  # корректно
        # nodes: [task1, task3]  # ошибка, task3 не существует
```

## Уровни валидации

Валидатор может работать на разных уровнях:

1. **Синтаксис** — корректность YAML/JSON.
2. **Схема** — соответствие JSON Schema (типы полей, обязательные поля).
3. **Семантика** — ссылочная целостность, бизнес-правила.

## Сообщения об ошибках

Валидатор ДОЛЖЕН предоставлять понятные сообщения об ошибках:

- Путь к проблемному полю (например, `nodes.task2.parent`).
- Описание проблемы.
- Ожидаемое значение или формат.

Пример вывода:

```
Error: Invalid reference in nodes.task2.parent
  Value: "nonexistent"
  Expected: existing node ID from nodes
  Available: root, task1
```

---

# Расширяемость

opskarta специально допускает расширение формата без слома базовой совместимости.

## Правило расширений

- Любой узел может иметь дополнительные поля (например, `tags`, `owner`, `risk`, `links`).
- Базовые инструменты должны:
  - игнорировать неизвестные поля;
  - сохранять их при "parse → emit", если они делают форматирование.

## Рекомендуемый неймспейс

Чтобы не конфликтовать, можно группировать пользовательские поля:

```yaml
nodes:
  task1:
    title: "..."
    x:
      team: "SRE"
      risk: "high"
```

Это не обязательно, но удобно, когда формат начнут расширять разные люди.