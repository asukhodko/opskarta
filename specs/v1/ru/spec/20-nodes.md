# Узлы (`nodes`)

Узел — это единица работ/смысла в твоей карте.

## Идентификаторы узлов (node_id)

Каждый узел идентифицируется ключом в словаре `nodes`. Этот ключ (`node_id`) используется для ссылок в `parent`, `after` и `lanes[].nodes`.

### Требования

- `node_id` ДОЛЖЕН быть уникальным в пределах `nodes`.
- `node_id` ДОЛЖЕН быть строкой.

### Рекомендации

- **Рекомендуемый формат:** `^[a-zA-Z][a-zA-Z0-9._-]*$`
  - Начинается с буквы
  - Содержит только буквы, цифры, точки, подчёркивания, дефисы
- **Для совместимости с Mermaid:** избегайте пробелов, скобок, двоеточий в идентификаторах.

```yaml
# Хорошие идентификаторы
nodes:
  kickoff: ...
  phase_1: ...
  backend-api: ...
  JIRA.123: ...

# Проблемные идентификаторы (могут не работать в некоторых рендерерах)
nodes:
  "task with spaces": ...     # Пробелы
  "task:important": ...       # Двоеточие
  123: ...                    # Начинается с цифры
```

## Обязательные поля узла

- `title` *(string)* — имя работы.

## Рекомендуемые поля

- `kind` *(string)* — тип узла. Рекомендованные значения:
  - `summary` — верхнеуровневый контейнер
  - `phase` — этап/фаза
  - `epic` — крупная сущность в системе деталей
  - `user_story` — история/ценность
  - `task` — конкретная задача

- `status` *(string)* — ключ статуса из `statuses`.

- `parent` *(string)* — ID родительского узла (иерархия декомпозиции).

- `after` *(list[string])* — зависимости "после чего" (граф).  
  Семантика: узел может стартовать после завершения всех `after`.

- Планирование:
  - `start` *(YYYY-MM-DD)* — плановая дата старта
  - `finish` *(YYYY-MM-DD)* — целевая дата завершения (дедлайн). См. раздел "Планирование".
  - `duration` *(string)* — длительность, например `5d`. Если не указана для планируемого узла — по умолчанию `1d`.
  - `milestone` *(boolean)* — если `true`, узел является вехой (событием-точкой). См. ниже.

- `issue` *(string)* — ссылка/ключ в системе деталей (например, `JIRA-123`).

- `notes` *(string|multiline)* — заметки/контекст, который не хочется терять.

## Вехи (milestones)

Веха — это событие-точка на временной шкале, а не задача с длительностью. Используется для фиксации ключевых дат: релизы, дедлайны, контрольные точки.

### Поле `milestone`

- `milestone` *(boolean)* — если `true`, узел отображается как веха.

### Поведение

- Веха ДОЛЖНА иметь `start` или вычислимый `start` через `after`.
- Если `duration` не указан для вехи, используется `1d` для вычислений.
- На диаграмме Gantt веха отображается как точка/ромб, а не как полоса.
- Вехи могут иметь зависимости (`after`) и статусы (`status`).

### Пример

```yaml
nodes:
  release_v1:
    title: "Релиз v1.0"
    milestone: true
    start: "2024-03-15"
    status: not_started

  beta_release:
    title: "Бета-релиз"
    milestone: true
    after: [integration_testing]
    # start вычисляется из after
```

## Примечания

- opskarta не диктует workflow. `status` — это метка для твоей карты.
- Узел может существовать без `issue` (черновик, гипотеза, заготовка).

## Поле `finish` (дедлайн/обратное планирование)

Поле `finish` указывает целевую дату завершения или дедлайн для узла.

- `finish` *(string, YYYY-MM-DD)* — целевая дата завершения.

### Поведение

1. **Если указаны `finish` + `duration` без `start`:**
   - `start` вычисляется "назад" от `finish` путём вычитания рабочих дней.
   - Формула: `start = sub_workdays(finish, duration - 1)`, где `finish` включается в длительность.
   - Пример: `finish: 2024-03-15`, `duration: 5d` → `start: 2024-03-11` (5 рабочих дней: 11, 12, 13, 14, 15).

2. **Если указаны `start` + `finish` без `duration`:**
   - `duration` вычисляется как количество рабочих дней между датами.

3. **Если указаны все три (`start`, `finish`, `duration`):**
   - Они ДОЛЖНЫ быть согласованы (вычисленный `finish` из `start+duration` должен совпадать с указанным `finish`).
   - Несогласованность является **ошибкой**.

### Пример

```yaml
nodes:
  release_prep:
    title: "Подготовка к релизу"
    finish: "2024-03-15"  # Дедлайн
    duration: "5d"
    # start вычисляется назад: 2024-03-11 (5 рабочих дней: 11, 12, 13, 14, 15)
  
  feature_a:
    title: "Фича A"
    start: "2024-03-01"
    finish: "2024-03-05"
    # duration вычисляется: 5d
```