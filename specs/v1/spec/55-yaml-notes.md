# Рекомендации по кодированию YAML

Формат opskarta использует YAML (рекомендуется) или JSON для сериализации. В этом разделе описаны рекомендации по корректному кодированию данных в YAML.

## Даты (поле `start`)

YAML-парсеры (особенно YAML 1.1, включая PyYAML по умолчанию) могут автоматически преобразовывать строки, похожие на даты, в специальные типы данных (date/datetime). Это может привести к неожиданному поведению.

### Настоятельно рекомендуемый формат

```yaml
nodes:
  task1:
    title: "Задача"
    start: "2024-03-15"  # Строка в кавычках — НАСТОЯТЕЛЬНО РЕКОМЕНДУЕТСЯ
    duration: "5d"
```

### Допустимый, но рискованный формат

```yaml
nodes:
  task1:
    title: "Задача"
    start: 2024-03-15  # Без кавычек — PyYAML 1.1 преобразует в тип date!
    duration: 5d       # Без кавычек — валидный plain scalar, но лучше в кавычках
```

> **Внимание:** `start: 2024-03-15` без кавычек в PyYAML будет преобразовано в Python `datetime.date(2024, 3, 15)`, а не в строку `"2024-03-15"`. Инструменты opskarta ДОЛЖНЫ нормализовать такие значения (см. раздел "Нормализация типов").

## Длительность (поле `duration`)

Значение `duration` ДОЛЖНО быть строкой в формате `<число><единица>` (например, `5d`, `2w`).

### Корректные примеры

```yaml
duration: "5d"   # 5 дней (рекомендуемый формат)
duration: "2w"   # 2 недели (= 10 рабочих дней)
duration: "10d"  # 10 дней
duration: 5d     # Валидный YAML plain scalar, парсится как строка "5d"
```

> **Примечание:** `5d` без кавычек является валидным YAML plain scalar и корректно парсится как строка. Кавычки рекомендуются для единообразия с полем `start`, но не обязательны.

### Некорректные примеры

```yaml
duration: 5      # Число без единицы — не соответствует формату
duration: "0d"   # Ноль недопустим
duration: "-1d"  # Отрицательные значения недопустимы
```

## Эквивалентность YAML и JSON

Формат данных opskarta является JSON-совместимым. YAML рекомендуется как более удобный синтаксис для ручного редактирования, но инструменты ДОЛЖНЫ приводить YAML-значения к каноническим типам opskarta (см. раздел "Нормализация типов").

> **Важно:** YAML является надмножеством JSON, но YAML 1.1 парсеры (например, PyYAML) имеют особенности авто-типизации, которые могут приводить к неожиданным результатам. Инструменты opskarta ДОЛЖНЫ корректно обрабатывать такие случаи.

### YAML

```yaml
version: 1
meta:
  id: "my-project"
  title: "Мой проект"
nodes:
  task1:
    title: "Первая задача"
    start: "2024-03-01"
    duration: "5d"
  task2:
    title: "Вторая задача"
    after:
      - task1
    duration: "3d"
```

### JSON (эквивалент)

```json
{
  "version": 1,
  "meta": {
    "id": "my-project",
    "title": "Мой проект"
  },
  "nodes": {
    "task1": {
      "title": "Первая задача",
      "start": "2024-03-01",
      "duration": "5d"
    },
    "task2": {
      "title": "Вторая задача",
      "after": ["task1"],
      "duration": "3d"
    }
  }
}
```

## Многострочные строки (поле `notes`)

Для многострочных заметок используйте литеральный блок (`|`) или свёрнутый блок (`>`):

### Литеральный блок (сохраняет переводы строк)

```yaml
nodes:
  task1:
    title: "Задача с заметками"
    notes: |
      Первая строка заметки.
      Вторая строка заметки.
      
      Абзац после пустой строки.
```

### Свёрнутый блок (объединяет строки)

```yaml
nodes:
  task1:
    title: "Задача с заметками"
    notes: >
      Это длинная заметка, которая
      будет объединена в одну строку
      с пробелами между частями.
```

## Специальные символы

При использовании специальных символов в строках заключайте их в кавычки:

```yaml
nodes:
  task1:
    title: "Задача: важная!"      # Двоеточие требует кавычек
    issue: "JIRA-123"             # Без проблем
    notes: "Заметка с # символом" # Решётка требует кавычек
```

## Нормализация типов

Инструменты opskarta (валидаторы, рендереры) ДОЛЖНЫ нормализовать YAML-значения к каноническим типам opskarta:

### Канонические типы полей

| Поле | Канонический тип | Допустимый YAML-вход | Нормализация |
|------|------------------|----------------------|--------------|
| `start` | строка `YYYY-MM-DD` | строка или YAML-дата | `date(2024, 3, 15)` → `"2024-03-15"` |
| `duration` | строка `Nd` или `Nw` | строка | — |
| `node_id` (ключи в `nodes`) | строка | строка | — |

### Правила нормализации

1. **Поле `start`:**
   - Если YAML-парсер вернул объект типа `date` или `datetime`, инструмент ДОЛЖЕН преобразовать его в строку формата `YYYY-MM-DD`.
   - Пример: Python `datetime.date(2024, 3, 15)` → строка `"2024-03-15"`.

2. **Идентификаторы узлов (`node_id`):**
   - Ключи в словаре `nodes` ДОЛЖНЫ быть строками.
   - Если YAML-парсер вернул нестроковый ключ (например, число), инструмент МОЖЕТ преобразовать его в строку или отвергнуть с ошибкой.
   - Рекомендация: отвергать нестроковые ключи для явности.

3. **Общий принцип:**
   - Инструменты НЕ ДОЛЖНЫ падать на корректных YAML-файлах только из-за особенностей YAML-типизации.
   - Инструменты ДОЛЖНЫ приводить значения к каноническим типам перед дальнейшей обработкой.

### Пример нормализации в Python

```python
from datetime import date, datetime

def normalize_start(value):
    """Нормализует значение start к строке YYYY-MM-DD."""
    if isinstance(value, datetime):
        return value.date().isoformat()
    if isinstance(value, date):
        return value.isoformat()
    if isinstance(value, str):
        return value.strip()
    raise ValueError(f"Invalid start type: {type(value)}")
```
