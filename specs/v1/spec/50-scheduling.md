# Планирование (`start`, `duration`, `after`, `excludes`)

Поля планирования позволяют задать временные характеристики узлов и зависимости между ними.

## Термины

- **Планируемый узел (scheduled)** — узел, для которого можно вычислить дату начала (`start`). Такие узлы отображаются на временной шкале.
- **Непланируемый узел (unscheduled)** — узел без явного `start` и без вычислимого `start` через `after`. Такие узлы НЕ отображаются на временной шкале.

## Поля планирования

### `start` *(string, YYYY-MM-DD)*

Плановая дата начала работы. Формат: ISO 8601 дата, например `2024-03-15`.

- Если указан `start`, узел считается **планируемым**.
- `start` ДОЛЖЕН быть строкой в формате `YYYY-MM-DD`.

### `duration` *(string)*

Длительность работы. Формат: `<число><единица>`, где:

- `d` — дни (например, `5d` = 5 дней)
- `w` — недели (например, `2w` = 2 недели)

**Семантика единицы `w` (недели):**

- `1w` = 5 рабочих дней (не 7 календарных).
- При наличии `excludes: ["weekends"]` в представлении, неделя остаётся равной 5 рабочим дням.
- Пример: `2w` = 10 рабочих дней.

**Правила:**

- Число ДОЛЖНО быть положительным целым (≥ 1).
- Формат ДОЛЖЕН соответствовать регулярному выражению: `^[1-9][0-9]*[dw]$`.
- `duration` без `start` или `after` не определяет позицию на временной шкале, но может использоваться для оценки трудозатрат.

### `after` *(list[string])*

Список ID узлов-зависимостей.

**Семантика:** узел может стартовать только после завершения **всех** узлов из списка `after`.

## Вычисление дат

### Дата окончания (finish)

Дата окончания вычисляется по формуле:

```
finish = start + (duration_days - 1)
```

где `duration_days` — длительность в рабочих днях.

**Пояснение:** день начала (`start`) включается в длительность. Узел с `duration: 1d` начинается и заканчивается в один день.

**Примеры:**

| start | duration | finish | Пояснение |
|-------|----------|--------|-----------|
| 2024-03-01 | 1d | 2024-03-01 | Один день работы |
| 2024-03-01 | 5d | 2024-03-05 | Пять дней: 01, 02, 03, 04, 05 |
| 2024-03-01 (пт) | 5d (без excludes) | 2024-03-05 | Календарные дни |
| 2024-03-01 (пт) | 5d (с excludes: weekends) | 2024-03-07 | Рабочие дни: пт, пн, вт, ср, чт |

### Вычисление start из after

Если `start` не указан, но указан `after`, дата старта вычисляется как:

```
start = max(finish для всех зависимостей) + 1 рабочий день
```

**Алгоритм:**

1. Для каждой зависимости из `after` вычислить её `finish`.
2. Найти максимальную дату `finish` среди всех зависимостей.
3. Добавить 1 рабочий день (с учётом `excludes`, если применимо).

**Пример:**

```yaml
nodes:
  task_a:
    title: "Задача A"
    start: "2024-03-01"
    duration: "3d"
    # finish = 2024-03-03 (пн, вт, ср)

  task_b:
    title: "Задача B"
    after: [task_a]
    duration: "2d"
    # start = 2024-03-04 (чт), finish = 2024-03-05 (пт)
```

### Одновременное наличие start и after

Если узел имеет и `start`, и `after`:

- **`start` имеет приоритет** — используется явно указанная дата.
- **`after` становится логической зависимостью** — отображается как связь (стрелка) на диаграмме, но не влияет на дату старта.

**Пример:**

```yaml
nodes:
  dependency:
    title: "Зависимость"
    start: "2024-03-01"
    duration: "5d"
    # finish = 2024-03-05

  task_with_both:
    title: "Задача с явным стартом"
    start: "2024-03-04"  # Явная дата (раньше finish зависимости!)
    after: [dependency]   # Логическая связь для диаграммы
    duration: "3d"
    # start = 2024-03-04 (используется явный start, не вычисленный)
    # finish = 2024-03-06
```

В этом примере `task_with_both` начнётся 04.03, хотя `dependency` заканчивается 05.03. Это может быть намеренным (например, параллельная работа) или ошибкой в планировании — инструменты МОГУТ выдавать предупреждение.

### Непланируемые узлы

Узел считается **непланируемым**, если:

1. Отсутствует `start`, И
2. Отсутствует `after`, ИЛИ все зависимости в `after` сами непланируемые.

**Core-поведение:** непланируемые узлы НЕ отображаются на временной шкале Gantt. Это нормативное правило для всех инструментов.

> **Примечание:** рендереры МОГУТ предоставлять расширения (например, `x.scheduling.anchor_to_parent_start`) для опционального наследования дат от родительских узлов. Такие расширения являются non-core и ДОЛЖНЫ быть документированы отдельно.

## Исключения календаря (excludes)

Параметр `excludes` задаётся на уровне представления (`gantt_views`) и влияет на расчёт дат.

### Поддерживаемые значения

- `"weekends"` — исключить субботу и воскресенье из рабочих дней.

### Влияние на вычисления

При наличии `excludes: ["weekends"]`:

1. **Длительность** считается в рабочих днях (пн-пт).
2. **Дата окончания** пропускает выходные.
3. **Следующий рабочий день** после зависимости пропускает выходные.

**Пример с weekends:**

```yaml
# В представлении: excludes: ["weekends"]

nodes:
  friday_task:
    title: "Начало в пятницу"
    start: "2024-03-01"  # Пятница
    duration: "3d"
    # Рабочие дни: пт (01), пн (04), вт (05)
    # finish = 2024-03-05 (вторник)

  next_task:
    title: "После friday_task"
    after: [friday_task]
    duration: "2d"
    # start = 2024-03-06 (среда)
    # finish = 2024-03-07 (четверг)
```

### Конкретные даты в excludes

Представления МОГУТ содержать конкретные даты в `excludes` (например, `["weekends", "2024-03-08"]`). Такие даты являются **подсказками для рендерера** и НЕ влияют на core-алгоритм вычисления дат.

## Примеры

### Узел с фиксированной датой старта

```yaml
nodes:
  kickoff:
    title: "Kickoff"
    start: "2024-03-01"
    duration: "1d"
```

### Узел с зависимостью

```yaml
nodes:
  design:
    title: "Дизайн"
    start: "2024-03-01"
    duration: "5d"

  implementation:
    title: "Реализация"
    after: [design]
    duration: "10d"
```

В этом примере `implementation` может начаться только после завершения `design`.

### Узел с несколькими зависимостями

```yaml
nodes:
  backend:
    title: "Backend API"
    start: "2024-03-01"
    duration: "5d"

  frontend:
    title: "Frontend UI"
    start: "2024-03-01"
    duration: "3d"

  integration:
    title: "Интеграция"
    after: [backend, frontend]
    duration: "2d"
```

Узел `integration` ждёт завершения **обоих** узлов `backend` и `frontend`. Его `start` будет вычислен как следующий день после `max(finish(backend), finish(frontend))`.

### Узел с duration в неделях

```yaml
nodes:
  sprint:
    title: "Спринт разработки"
    start: "2024-03-04"  # Понедельник
    duration: "2w"       # = 10 рабочих дней
    # finish = 2024-03-15 (пятница второй недели)
```

## Взаимодействие с представлениями

Поля планирования используются рендерерами для построения временных диаграмм:

- **Gantt-диаграммы**: `start` и `duration` определяют позицию и длину полосы узла на временной шкале.
- **Зависимости**: `after` отображается как стрелки между узлами.
- **Исключения календаря**: параметр `excludes` в `gantt_views` влияет на расчёт дат при наличии `duration`.
