# Правила валидации

Этот раздел описывает правила валидации файлов плана и представлений.

## Валидация файла плана (`*.plan.yaml`)

### Обязательные поля

- `version` *(int)* — ДОЛЖЕН присутствовать в корне документа.
- `nodes` *(object)* — ДОЛЖЕН присутствовать (может быть пустым).
- Для каждого узла: `title` *(string)* — обязательное поле.

### Поле `meta.id`

- `meta.id` РЕКОМЕНДУЕТСЯ для всех файлов плана.
- `meta.id` ОБЯЗАТЕЛЕН, если файл плана используется совместно с файлом представлений (`*.views.yaml`).

```yaml
# Минимальный план (без views)
version: 1
nodes:
  task1:
    title: "Задача"

# План для использования с views (meta.id обязателен)
version: 1
meta:
  id: "my-project"
  title: "Мой проект"
nodes:
  task1:
    title: "Задача"
```

### Ссылочная целостность

#### Родительские ссылки (`parent`)

- Если узел содержит поле `parent`, значение ДОЛЖНО быть ключом существующего узла в `nodes`.
- Циклические ссылки через `parent` запрещены.

```yaml
# Корректно
nodes:
  root:
    title: "Root"
  child:
    title: "Child"
    parent: root  # root существует

# Ошибка: несуществующий parent
nodes:
  child:
    title: "Child"
    parent: nonexistent  # ошибка!
```

#### Зависимости (`after`)

- Каждый элемент списка `after` ДОЛЖЕН быть ключом существующего узла в `nodes`.
- Циклические зависимости через `after` запрещены.

```yaml
# Корректно
nodes:
  task1:
    title: "Task 1"
  task2:
    title: "Task 2"
    after: [task1]  # task1 существует

# Ошибка: несуществующая зависимость
nodes:
  task2:
    title: "Task 2"
    after: [missing_task]  # ошибка!
```

#### Статусы (`status`)

- Если узел содержит поле `status`, значение ДОЛЖНО быть ключом из словаря `statuses`.

```yaml
statuses:
  done: { label: "Готово" }

nodes:
  task:
    title: "Task"
    status: done  # корректно, done есть в statuses

# Ошибка: несуществующий статус
nodes:
  task:
    title: "Task"
    status: completed  # ошибка, если completed нет в statuses!
```

### Формат полей планирования

#### Поле `start`

- Если указан, ДОЛЖЕН соответствовать формату `YYYY-MM-DD`.
- Формат: регулярное выражение `^\d{4}-\d{2}-\d{2}$`.
- РЕКОМЕНДУЕТСЯ проверять корректность даты (существующий день календаря).

```yaml
# Корректно
start: "2024-03-15"

# Ошибки формата
start: "2024-3-15"   # месяц без ведущего нуля
start: "15-03-2024"  # неверный порядок
start: "2024/03/15"  # неверный разделитель
```

#### Поле `duration`

- Если указан, ДОЛЖЕН соответствовать формату `<число><единица>`.
- Формат: регулярное выражение `^[1-9][0-9]*[dw]$`.
- Единицы: `d` (дни), `w` (недели, где 1w = 5 рабочих дней).
- Число ДОЛЖНО быть положительным целым (≥ 1).

```yaml
# Корректно
duration: "5d"   # 5 дней
duration: "2w"   # 2 недели (10 рабочих дней)
duration: "10d"  # 10 дней

# Ошибки формата
duration: "0d"   # ноль недопустим
duration: "-1d"  # отрицательные недопустимы
duration: "5"    # отсутствует единица
duration: "5m"   # неизвестная единица
duration: "d5"   # неверный порядок
```

## Валидация файла представлений (`*.views.yaml`)

### Обязательные поля

- `version` *(int)* — ДОЛЖЕН присутствовать.
- `project` *(string)* — ДОЛЖЕН присутствовать.

### Связь с файлом плана

- Поле `project` ДОЛЖНО совпадать с `meta.id` соответствующего файла плана.
- Если в файле плана отсутствует `meta.id`, валидация связи ДОЛЖНА завершиться ошибкой.

```yaml
# plan.yaml
meta:
  id: my-project

# views.yaml
project: my-project  # должно совпадать с meta.id
```

### Ссылки на узлы в представлениях

- Каждый `node_id` в `lanes[].nodes` ДОЛЖЕН существовать в файле плана.

```yaml
# Если в плане есть nodes: {task1, task2}
gantt_views:
  overview:
    lanes:
      main:
        nodes: [task1, task2]  # корректно
        # nodes: [task1, task3]  # ошибка, task3 не существует
```

### Поле `excludes` в представлениях

- Поле `excludes` в `gantt_views` МОЖЕТ содержать:
  - `"weekends"` — влияет на алгоритм расчёта дат (см. раздел "Планирование").
  - Конкретные даты в формате `YYYY-MM-DD` — являются **подсказками для рендерера** и НЕ влияют на core-алгоритм вычисления дат.

```yaml
gantt_views:
  overview:
    excludes:
      - weekends        # core: влияет на расчёт дат
      - "2024-03-08"    # non-core: подсказка для рендерера (праздник)
```

> **Примечание:** валидатор МОЖЕТ выдавать информационное предупреждение о наличии конкретных дат в `excludes`, указывая, что они не влияют на core-алгоритм.

## Уровни валидации

Валидатор может работать на разных уровнях:

1. **Синтаксис** — корректность YAML/JSON.
2. **Схема** — соответствие JSON Schema (типы полей, обязательные поля, форматы).
3. **Семантика** — ссылочная целостность, бизнес-правила, корректность дат.

## Уровни серьёзности (severity)

Валидатор ДОЛЖЕН классифицировать проблемы по уровням серьёзности:

| Уровень | Описание | Поведение |
|---------|----------|-----------|
| **error** | Критическая ошибка, делающая файл невалидным | Валидация завершается неудачей (exit code ≠ 0) |
| **warn** | Потенциальная проблема, требующая внимания | Валидация успешна, но выводится предупреждение |
| **info** | Информационное сообщение | Валидация успешна |

### Классификация проблем

| Проблема | Уровень |
|----------|---------|
| Отсутствие обязательных полей (`version`, `nodes`, `title`) | error |
| Несуществующие ссылки (`parent`, `after`, `status`) | error |
| Циклические зависимости (`parent`, `after`) | error |
| Дубликаты `node_id` в `nodes` | error |
| Неверный формат `start` или `duration` | error |
| Неверный формат `color` в `statuses` | error |
| Явный `start` раньше завершения зависимостей (`after`) | warn |
| Отсутствие `duration` у планируемого узла | warn |
| Конкретные даты в `excludes` (не влияют на core-алгоритм) | info |
| Непланируемые узлы (не отображаются на диаграмме) | info |

## Дополнительные правила валидации

### Уникальность идентификаторов узлов

Каждый `node_id` (ключ в словаре `nodes`) ДОЛЖЕН быть уникальным.

> **Важно:** некоторые YAML-парсеры (например, PyYAML) молча берут последнее значение при дублировании ключей. Валидатор ДОЛЖЕН детектировать дубликаты насколько это возможно и выдавать ошибку.

```yaml
# Ошибка: дублирование node_id
nodes:
  task1:
    title: "Первая версия"
  task1:                    # ОШИБКА: дубликат ключа!
    title: "Вторая версия"
```

### Конфликт start и after

Если узел имеет и `start`, и `after`, и явный `start` раньше вычисленного завершения зависимостей — валидатор ДОЛЖЕН выдать предупреждение:

```yaml
nodes:
  dependency:
    title: "Зависимость"
    start: "2024-03-01"
    duration: "5d"
    # finish = 2024-03-05

  task:
    title: "Задача"
    start: "2024-03-03"     # WARN: раньше finish зависимости (2024-03-05)!
    after: [dependency]
    duration: "2d"
```

### Формат цвета в статусах

Поле `color` в `statuses` ДОЛЖНО быть валидным hex-цветом:

- Формат: регулярное выражение `^#[0-9a-fA-F]{6}$`.
- Примеры корректных значений: `#22c55e`, `#9CA3AF`, `#fecaca`.

```yaml
statuses:
  done:
    label: "Готово"
    color: "#22c55e"    # корректно
  
  invalid:
    label: "Неверный"
    color: "green"      # ОШИБКА: должен быть hex-формат
```

## Сообщения об ошибках

Валидатор ДОЛЖЕН предоставлять понятные сообщения об ошибках:

- Путь к проблемному полю (например, `nodes.task2.parent`).
- Описание проблемы.
- Ожидаемое значение или формат.

Пример вывода:

```
Error: Invalid reference in nodes.task2.parent
  Value: "nonexistent"
  Expected: existing node ID from nodes
  Available: root, task1
```

```
Error: Invalid duration format in nodes.task1.duration
  Value: "5"
  Expected: format <number><unit> where unit is 'd' or 'w'
  Pattern: ^[1-9][0-9]*[dw]$
```
