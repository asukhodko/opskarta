# Расширяемость

opskarta специально допускает расширение формата без нарушения базовой совместимости.

## Области расширяемости

Дополнительные поля (расширения) допустимы в следующих местах:

### Файл плана (`*.plan.yaml`)

| Уровень | Пример расположения | Описание |
|---------|---------------------|----------|
| Корень файла | `version`, `meta`, `nodes`, **`x:`** | Метаданные проекта |
| Объект `meta` | `meta.id`, `meta.title`, **`meta.x:`** | Расширенные метаданные |
| Объект `statuses.*` | `statuses.done.label`, **`statuses.done.x:`** | Дополнительные атрибуты статуса |
| Объект узла `nodes.*` | `nodes.task1.title`, **`nodes.task1.x:`** | Пользовательские атрибуты узла |

### Файл представлений (`*.views.yaml`)

| Уровень | Пример расположения | Описание |
|---------|---------------------|----------|
| Корень файла | `version`, `project`, **`x:`** | Метаданные представлений |
| Объект `gantt_views.*` | `gantt_views.main.title`, **`gantt_views.main.x:`** | Настройки представления |
| Объект `lanes.*` | `lanes.dev.title`, **`lanes.dev.x:`** | Настройки дорожки |

## Правила для инструментов

Базовые инструменты (валидаторы, рендереры) ДОЛЖНЫ:

1. **Игнорировать неизвестные поля** — не выдавать ошибку при встрече неизвестного поля.
2. **Сохранять неизвестные поля** — при операциях "parse → emit" (чтение и запись) неизвестные поля ДОЛЖНЫ быть сохранены.

## Рекомендуемый namespace `x:`

Для пользовательских и рендер-специфичных полей РЕКОМЕНДУЕТСЯ использовать namespace `x:`:

```yaml
# В корне плана
version: 1
meta:
  id: "my-project"
  title: "Мой проект"
x:
  team_assignments:
    - team: "Backend"
      lead: "Alice"
  risk_register:
    - risk_id: "R1"
      description: "Зависимость от внешнего API"

nodes:
  task1:
    title: "Задача 1"
    x:
      team: "SRE"
      risk: "high"
      custom_field: "любое значение"
```

```yaml
# В представлениях
version: 1
project: "my-project"
x:
  theme: "dark"
  export_format: "png"

gantt_views:
  main:
    title: "Основной план"
    x:
      zoom_level: "week"
    lanes:
      dev:
        title: "Разработка"
        nodes: [task1, task2]
        x:
          color: "#3498db"
```

### Зачем использовать `x:`

1. **Избежание конфликтов** — новые версии спецификации не будут конфликтовать с вашими расширениями.
2. **Явная маркировка** — понятно, что это расширение, а не часть core-спецификации.
3. **Группировка** — все пользовательские поля собраны в одном месте.

### Когда `x:` не обязателен

Использование `x:` РЕКОМЕНДУЕТСЯ, но не обязательно. Следующие форматы также допустимы:

```yaml
# Допустимо (но не рекомендуется)
nodes:
  task1:
    title: "Задача"
    team: "SRE"          # расширение без namespace
    risk: "high"         # расширение без namespace

# Рекомендуется
nodes:
  task1:
    title: "Задача"
    x:
      team: "SRE"
      risk: "high"
```

## Расширения рендереров

Рендереры МОГУТ поддерживать специфичные расширения. Такие расширения ДОЛЖНЫ:

1. Быть документированы в профиле рендерера (см. "Renderer profile: Mermaid Gantt").
2. Использовать namespace `x:` или явный namespace рендерера (например, `x.mermaid:`).
3. Не влиять на core-семантику формата.

**Пример расширения для планирования:**

```yaml
nodes:
  child_task:
    title: "Дочерняя задача"
    parent: parent_task
    x:
      scheduling:
        anchor_to_parent_start: true  # Опциональное наследование даты от родителя
```

## JSON Schema и расширяемость

JSON Schema для opskarta использует `additionalProperties: true` на всех уровнях, где разрешены расширения. Это означает:

- Схема НЕ выдаст ошибку для неизвестных полей.
- Расширения валидируются только по типам (если указаны в схеме расширения).

Если вам нужна валидация пользовательских расширений, создайте собственную JSON Schema, расширяющую базовую.
